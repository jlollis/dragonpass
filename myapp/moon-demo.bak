#lang racket/base

(require (prefix-in dispatch: web-server/dispatch)
         (prefix-in dispatch-log: web-server/dispatchers/dispatch-log)
         (prefix-in xexpr: web-server/http/xexpr)
         (prefix-in servlet: web-server/servlet-env))
(require txexpr)

(define (not-found-route request)
  (xexpr:response/xexpr
   `(html (body (h2 "Uh-oh! Page not found.")))))

(define (home-route request)
  (xexpr:response/xexpr
   `(html (body (h2 "My Website")))))

(define (moon req width height)
  (define svg ;; a complicated txexpr?)
  (parameterize ([empty-tag-shorthand 'always])
    ;; SVG built, let's deliver it
    (response/full
       200
       #"OK"
       (current-seconds)
       #"image/svg+xml"
       empty
       (list (string->bytes/utf-8
              (format "~a~%~a~%"
                      "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"
                      (xexpr->string svg))))))))
  
(define-values (route-dispatch route-url)
  (dispatch:dispatch-rules
   [("") home-route]
   [else not-found-route]))

(define (route-dispatch/log-middleware req)
  (display (dispatch-log:apache-default-format req))
  (flush-output)
  (route-dispatch req))

(servlet:serve/servlet
 route-dispatch/log-middleware
 #:servlet-path "/"
 #:servlet-regexp #rx""
 #:stateless? #t)